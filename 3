from azure.cosmos import CosmosClient, exceptions
import requests

# Cosmos DB configuration
COSMOS_DB_URL = 'your_cosmos_db_url'
COSMOS_DB_KEY = 'your_cosmos_db_key'
COSMOS_DB_DATABASE_NAME = 'your_database_name'
COSMOS_DB_CONTAINER_NAME = 'your_container_name'

# Airflow configuration
AIRFLOW_URL = 'http://your_airflow_url'

# Initialize Cosmos DB client
cosmos_client = CosmosClient(COSMOS_DB_URL, credential=COSMOS_DB_KEY)
database = cosmos_client.get_database_client(COSMOS_DB_DATABASE_NAME)
container = database.get_container_client(COSMOS_DB_CONTAINER_NAME)

def get_dag_id_from_cosmos():
    query = "SELECT c.dagId FROM c ORDER BY c._ts DESC LIMIT 1"
    try:
        items = list(container.query_items(query=query, enable_cross_partition_query=True))
        return items[0]['dagId'] if items else None
    except exceptions.CosmosException as e:
        print(f"Error querying Cosmos DB: {e}")
        return None

def get_airflow_dag_status(dag_id):
    dag_endpoint = f"{AIRFLOW_URL}/api/v1/dags/{dag_id}"
    dag_runs_endpoint = f"{AIRFLOW_URL}/api/v1/dags/{dag_id}/dagRuns"
    try:
        dag_response = requests.get(dag_endpoint)
        dag_runs_response = requests.get(dag_runs_endpoint)
        dag_response.raise_for_status()
        dag_runs_response.raise_for_status()
        return dag_response.json(), dag_runs_response.json()
    except requests.RequestException as e:
        print(f"Error fetching from Airflow: {e}")
        return None, None

def store_dag_info_in_cosmos(dag_id, dag_status, dag_runs):
    document = {
        "id": dag_id,
        "status": dag_status,
        "runs": dag_runs
    }
    try:
        container.upsert_item(document)
        print("DAG information stored successfully in Cosmos DB.")
    except exceptions.CosmosException as e:
        print(f"Error storing data in Cosmos DB: {e}")

# Main execution workflow
dag_id = get_dag_id_from_cosmos()
if dag_id:
    dag_status, dag_runs = get_airflow_dag_status(dag_id)
    if dag_status and dag_runs:
        store_dag_info_in_cosmos(dag_id, dag_status, dag_runs)
    else:
        print("Failed to retrieve DAG details from Airflow.")
else:
    print("No DAG ID found in Cosmos DB.")
